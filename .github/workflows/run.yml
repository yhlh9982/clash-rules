name: Update Tracker Rules

# 触发条件
on:
  # 定时触发：每天北京时间 12:00 (UTC 4:00) 运行
  schedule:
    - cron: '0 4 * * *'
  # 手动触发：允许你在 Actions 页面点击按钮手动运行
  workflow_dispatch:

# 权限设置：允许 Actions 修改并提交代码
permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1. 拉取代码
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. 设置 Python 环境
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      # 3. 安装依赖
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      # 4. 运行你的转换脚本
      - name: Run conversion script
        run: |
          python convert_trackers.py

      # 5. 提交并推送到仓库
      - name: Commit and push changes
        run: |
          # 配置 Git 用户信息（显示为 GitHub Action 机器人）
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # 添加生成的文件
          git add trackers_domain.yaml trackers_ip.yaml
          
          # 提交更改
          # || exit 0 的意思是：如果没有文件变化（今天tracker没变），不报错退出
          git commit -m "Auto update trackers list [$(date)]" || exit 0
          
          # 推送回仓库
          git push
